<?xml version="1.0" encoding="UTF-8"?>
<mule xmlns="http://www.mulesoft.org/schema/mule/core"
  xmlns:doc="http://www.mulesoft.org/schema/mule/documentation"
  xmlns:ee="http://www.mulesoft.org/schema/mule/ee/core"
  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xmlns:http="http://www.mulesoft.org/schema/mule/http"
	xmlns:db="http://www.mulesoft.org/schema/mule/db"
      xsi:schemaLocation="http://www.mulesoft.org/schema/mule/core http://www.mulesoft.org/schema/mule/core/current/mule.xsd
      http://www.mulesoft.org/schema/mule/ee/core http://www.mulesoft.org/schema/mule/ee/core/current/mule-ee.xsd
	http://www.mulesoft.org/schema/mule/http http://www.mulesoft.org/schema/mule/http/current/mule-http.xsd
	http://www.mulesoft.org/schema/mule/db http://www.mulesoft.org/schema/mule/db/current/mule-db.xsd">

  <!-- GET /parties - Business Logic Flow -->
  <flow name="get-parties-business-logic" doc:name="get-parties-business-logic">
    <try doc:name="Try">
      <db:select config-ref="Database_Config" doc:name="Select Global Parties">
        <db:sql><![CDATA[
          SELECT *
          FROM global_parties
          WHERE
            (NULLIF(:globalId, '') IS NULL OR global_id = NULLIF(:globalId, '')::uuid)
            AND (COALESCE(:partyType, '') = '' OR party_type = :partyType)
            AND (COALESCE(:lastName, '') = '' OR last_name = :lastName)
            AND (COALESCE(:taxId, '') = '' OR tax_id = :taxId)
          ORDER BY created_at DESC
          LIMIT CAST(COALESCE(:limit, '100') AS integer) OFFSET CAST(COALESCE(:offset, '0') AS integer)
        ]]></db:sql>
        <db:input-parameters><![CDATA[#[payload default {}]]]></db:input-parameters>
      </db:select>

      <ee:transform doc:name="Store Parties">
        <ee:variables>
          <ee:set-variable variableName="parties"><![CDATA[%dw 2.0
output application/java
---
if (payload is Array) payload else [payload] default []]]></ee:set-variable>
        </ee:variables>
      </ee:transform>

      <ee:transform doc:name="Store Party Global IDs">
        <ee:variables>
          <ee:set-variable variableName="partyGlobalIdsList"><![CDATA[%dw 2.0
output application/java
---
vars.parties map ((party) -> party.global_id)]]></ee:set-variable>
          <ee:set-variable variableName="externalIds"><![CDATA[%dw 2.0
output application/java
---
[]]]></ee:set-variable>
        </ee:variables>
      </ee:transform>

      <choice doc:name="Has Parties?">
        <when expression="#[sizeOf(vars.parties) > 0]">
          <foreach collection="#[vars.partyGlobalIdsList]" doc:name="For Each Party Global ID">
            <db:select config-ref="Database_Config" doc:name="Select External IDs">
              <db:sql><![CDATA[
                SELECT global_id, external_system, external_value
                FROM external_ids
                WHERE global_id = :partyGlobalId::uuid
                  AND entity_type = 'party'
              ]]></db:sql>
              <db:input-parameters><![CDATA[#[{
                partyGlobalId: payload as String
              }]]]></db:input-parameters>
            </db:select>
            <ee:transform doc:name="Collect External IDs">
              <ee:variables>
                <ee:set-variable variableName="externalIds"><![CDATA[%dw 2.0
output application/java
---
if (vars.externalIds == null) payload else vars.externalIds ++ payload]]></ee:set-variable>
              </ee:variables>
            </ee:transform>
          </foreach>
          <set-payload value="#[vars.externalIds default []]" doc:name="Set External IDs Payload"/>
        </when>
        <otherwise>
          <set-payload value="#[[]]" doc:name="Set Empty Array"/>
        </otherwise>
      </choice>

      <ee:transform doc:name="Transform to Party Response">
        <ee:message>
          <ee:set-payload><![CDATA[%dw 2.0
output application/json
var parties = vars.parties
var externalIds = payload
var externalIdsByParty = externalIds groupBy $.global_id
---
parties map ((party) -> {
  id: party.id as String,
  globalId: party.global_id as String,
  partyType: party.party_type,
  firstName: party.first_name,
  lastName: party.last_name,
  middleName: party.middle_name,
  organizationName: party.organization_name,
  dateOfBirth: party.date_of_birth,
  taxId: party.tax_id,
  externalIds: (externalIdsByParty[party.global_id as String] default []) map ((ext) -> {
    system: ext.external_system,
    value: ext.external_value
  }),
  createdAt: party.created_at,
  updatedAt: party.updated_at
})]]></ee:set-payload>
        </ee:message>
      </ee:transform>

      <set-variable value="200" doc:name="httpStatus" doc:id="d3d4a356-1b30-4ea3-bf48-82e66c597694" variableName="httpStatus"/>
      
      <error-handler>
        <on-error-propagate type="*" enableNotifications="true" logException="true" doc:name="Error Handler">
          <ee:transform doc:name="Transform Error">
            <ee:message>
              <ee:set-payload><![CDATA[%dw 2.0
output application/json
---
{
  error: {
    code: "DATABASE_ERROR",
    message: "An error occurred while querying the database",
    timestamp: now()
  }
}]]></ee:set-payload>
            </ee:message>
          </ee:transform>
          <set-variable value="500" doc:name="httpStatus" doc:id="d3d4a356-1b30-4ea3-bf48-82e66c597694" variableName="httpStatus"/>
        </on-error-propagate>
      </error-handler>
    </try>
  </flow>

  <!-- POST /parties - Business Logic Flow -->
  <flow name="upsert-party-business-logic" doc:name="upsert-party-business-logic">
    <ee:transform doc:name="Transform Request to DB Format">
      <ee:message>
        <ee:set-payload><![CDATA[%dw 2.0
output application/java
fun normalizePartyType(pt) = 
  if (pt == null) "Individual"
  else if ((pt as String default "") == "") "Individual"
  else if (pt as String == "Individual" or pt as String == "individual" or pt as String == "INDIVIDUAL") "Individual"
  else if (pt as String == "Organization" or pt as String == "organization" or pt as String == "ORGANIZATION") "Organization"
  else pt as String
---
{
  global_id: payload.globalId default null,
  party_type: normalizePartyType(payload.partyType default null) default "Individual",
  first_name: payload.firstName default null,
  last_name: payload.lastName default null,
  middle_name: payload.middleName default null,
  organization_name: payload.organizationName default null,
  date_of_birth: payload.dateOfBirth default null,
  tax_id: payload.taxId default null
}]]></ee:set-payload>
      </ee:message>
      <ee:variables>
        <ee:set-variable variableName="partyData"><![CDATA[%dw 2.0
output application/java
---
payload]]></ee:set-variable>
        <ee:set-variable variableName="externalIds"><![CDATA[%dw 2.0
output application/java
--- payload.externalIds default []]]></ee:set-variable>
      </ee:variables>
    </ee:transform>

    <set-variable value="#[vars.partyData.tax_id]" variableName="taxId" doc:name="Store Tax ID" />
    <set-variable value="#[vars.partyData.global_id]" variableName="globalId" doc:name="Store Global ID" />

    <ee:transform doc:name="Prepare DB Parameters">
      <ee:message>
        <ee:set-payload><![CDATA[%dw 2.0
output application/java
var data = vars.partyData
fun ensurePartyType(pt) =
  if (pt == null) "Individual"
  else if ((pt as String default "") == "") "Individual"
  else if (pt as String == "Individual" or pt as String == "individual" or pt as String == "INDIVIDUAL") "Individual"
  else if (pt as String == "Organization" or pt as String == "organization" or pt as String == "ORGANIZATION") "Organization"
  else pt as String
---
{
  global_id: data.global_id,
  party_type: ensurePartyType(data.party_type),
  first_name: data.first_name,
  last_name: data.last_name,
  middle_name: data.middle_name,
  organization_name: data.organization_name,
  date_of_birth: data.date_of_birth,
  tax_id: data.tax_id
}]]></ee:set-payload>
      </ee:message>
    </ee:transform>

    <try doc:name="Try">
      <db:insert config-ref="Database_Config" doc:name="Upsert Party">
        <db:sql><![CDATA[
          INSERT INTO global_parties (
            global_id, party_type, first_name, last_name, middle_name,
            organization_name, date_of_birth, tax_id
          )
          VALUES (
            COALESCE(:global_id::uuid, gen_random_uuid()),
            :party_type, :first_name, :last_name, :middle_name,
            :organization_name, :date_of_birth::date, :tax_id
          )
          ON CONFLICT (global_id) DO UPDATE SET
            party_type = EXCLUDED.party_type,
            first_name = EXCLUDED.first_name,
            last_name = EXCLUDED.last_name,
            middle_name = EXCLUDED.middle_name,
            organization_name = EXCLUDED.organization_name,
            date_of_birth = EXCLUDED.date_of_birth,
            tax_id = EXCLUDED.tax_id,
            updated_at = CURRENT_TIMESTAMP
        ]]></db:sql>
        <db:input-parameters><![CDATA[#[payload]]]></db:input-parameters>
      </db:insert>

      <choice doc:name="Select Party by Identifier">
        <when expression="#[vars.globalId != null or vars.taxId != null]">
          <db:select config-ref="Database_Config" doc:name="Select Upserted Party by Identifier">
            <db:sql><![CDATA[
              SELECT *
              FROM global_parties
              WHERE (NULLIF(:globalId, '') IS NOT NULL AND global_id = NULLIF(:globalId, '')::uuid)
                 OR (COALESCE(:taxId, '') != '' AND tax_id = :taxId)
              ORDER BY updated_at DESC, created_at DESC
              LIMIT 1
            ]]></db:sql>
            <db:input-parameters><![CDATA[#[{
              globalId: if (vars.globalId != null) vars.globalId as String else "",
              taxId: if (vars.taxId != null) vars.taxId as String else ""
            }]]]></db:input-parameters>
          </db:select>
        </when>
        <otherwise>
          <db:select config-ref="Database_Config" doc:name="Select Last Upserted Party">
            <db:sql><![CDATA[
              SELECT *
              FROM global_parties
              ORDER BY updated_at DESC, created_at DESC
              LIMIT 1
            ]]></db:sql>
          </db:select>
        </otherwise>
      </choice>

      <ee:transform doc:name="Store Party">
        <ee:variables>
          <ee:set-variable variableName="party"><![CDATA[%dw 2.0
output application/java
---
payload[0] default {}]]></ee:set-variable>
          <ee:set-variable variableName="globalId"><![CDATA[%dw 2.0
output application/java
---
if (sizeOf(payload) > 0 and payload[0] != null) payload[0].global_id else null]]></ee:set-variable>
        </ee:variables>
      </ee:transform>

      <choice doc:name="Has External IDs?">
        <when expression="#[sizeOf(vars.externalIds) > 0 and vars.globalId != null]">
          <db:delete config-ref="Database_Config" doc:name="Delete Existing External IDs">
            <db:sql><![CDATA[
              DELETE FROM external_ids
              WHERE global_id = :globalId::uuid
                AND entity_type = 'party'
            ]]></db:sql>
            <db:input-parameters><![CDATA[#[{
              globalId: vars.globalId as String
            }]]]></db:input-parameters>
          </db:delete>

          <ee:transform doc:name="Transform External IDs for Insert">
            <ee:message>
              <ee:set-payload><![CDATA[%dw 2.0
output application/java
---
vars.externalIds map ((ext) -> {
  global_id: vars.globalId as String,
  entity_type: "party",
  external_system: ext.system,
  external_value: ext.value
})]]></ee:set-payload>
            </ee:message>
          </ee:transform>

          <foreach doc:name="Insert External IDs">
            <db:insert config-ref="Database_Config" doc:name="Insert External ID">
              <db:sql><![CDATA[
                INSERT INTO external_ids (
                  global_id, entity_type, external_system, external_value
                )
                VALUES (
                  :global_id::uuid, :entity_type, :external_system, :external_value
                )
                ON CONFLICT (external_system, external_value, entity_type) DO UPDATE SET
                  global_id = EXCLUDED.global_id
              ]]></db:sql>
              <db:input-parameters><![CDATA[#[payload]]]></db:input-parameters>
            </db:insert>
          </foreach>
        </when>
      </choice>

      <db:select config-ref="Database_Config" doc:name="Get External IDs">
        <db:sql><![CDATA[
          SELECT external_system, external_value
          FROM external_ids
          WHERE global_id = :globalId::uuid
            AND entity_type = 'party'
        ]]></db:sql>
        <db:input-parameters><![CDATA[#[{
          globalId: vars.globalId
        }]]]></db:input-parameters>
      </db:select>

      <ee:transform doc:name="Transform Response">
        <ee:message>
          <ee:set-payload><![CDATA[%dw 2.0
output application/json
var party = vars.party
var externalIds = payload
---
{
  id: party.id as String,
  globalId: party.global_id as String,
  partyType: party.party_type,
  firstName: party.first_name,
  lastName: party.last_name,
  middleName: party.middle_name,
  organizationName: party.organization_name,
  dateOfBirth: party.date_of_birth,
  taxId: party.tax_id,
  externalIds: externalIds map ((ext) -> {
    system: ext.external_system,
    value: ext.external_value
  }),
  createdAt: party.created_at,
  updatedAt: party.updated_at
}]]></ee:set-payload>
        </ee:message>
      </ee:transform>

      <set-variable value="#[if(vars.partyData.global_id == null) 201 else 200]" doc:name="httpStatus" doc:id="d3d4a356-1b30-4ea3-bf48-82e66c597694" variableName="httpStatus"/>
      
      <error-handler>
        <on-error-propagate type="*" enableNotifications="true" logException="true" doc:name="Error Handler">
          <ee:transform doc:name="Transform Error">
            <ee:message>
              <ee:set-payload><![CDATA[%dw 2.0
output application/json
---
{
  error: {
    code: "DATABASE_ERROR",
    message: "An error occurred while upserting the party",
    timestamp: now()
  }
}]]></ee:set-payload>
            </ee:message>
          </ee:transform>
          <set-variable value="500" doc:name="httpStatus" doc:id="d3d4a356-1b30-4ea3-bf48-82e66c597694" variableName="httpStatus"/>
        </on-error-propagate>
      </error-handler>
    </try>
  </flow>

  <!-- GET /parties/{partyGlobalId} - Business Logic Flow -->
  <flow name="get-party-by-global-id-business-logic" doc:name="get-party-by-global-id-business-logic">
    <try doc:name="Try">
      <db:select config-ref="Database_Config" doc:name="Select Party by Global ID">
        <db:sql><![CDATA[
          SELECT *
          FROM global_parties
          WHERE global_id = :partyGlobalId::uuid
        ]]></db:sql>
        <db:input-parameters><![CDATA[#[{
          partyGlobalId: vars.partyGlobalId
        }]]]></db:input-parameters>
      </db:select>

      <choice doc:name="Party Found?">
        <when expression="#[sizeOf(payload) > 0]">
          <ee:transform doc:name="Store Party">
            <ee:variables>
              <ee:set-variable variableName="party"><![CDATA[%dw 2.0
output application/java
--- payload[0]]]></ee:set-variable>
            </ee:variables>
          </ee:transform>

          <db:select config-ref="Database_Config" doc:name="Get External IDs">
            <db:sql><![CDATA[
              SELECT external_system, external_value
              FROM external_ids
              WHERE global_id = :partyGlobalId::uuid
                AND entity_type = 'party'
            ]]></db:sql>
            <db:input-parameters><![CDATA[#[{
              partyGlobalId: vars.partyGlobalId
            }]]]></db:input-parameters>
          </db:select>

          <ee:transform doc:name="Transform Response">
            <ee:message>
              <ee:set-payload><![CDATA[%dw 2.0
output application/json
var party = vars.party
var externalIds = payload
---
{
  id: party.id as String,
  globalId: party.global_id as String,
  partyType: party.party_type,
  firstName: party.first_name,
  lastName: party.last_name,
  middleName: party.middle_name,
  organizationName: party.organization_name,
  dateOfBirth: party.date_of_birth,
  taxId: party.tax_id,
  externalIds: externalIds map ((ext) -> {
    system: ext.external_system,
    value: ext.external_value
  }),
  createdAt: party.created_at,
  updatedAt: party.updated_at
}]]></ee:set-payload>
            </ee:message>
          </ee:transform>
          <set-variable value="200" doc:name="httpStatus" doc:id="d3d4a356-1b30-4ea3-bf48-82e66c597694" variableName="httpStatus"/>
        </when>
        <otherwise>
          <ee:transform doc:name="Error Response">
            <ee:message>
              <ee:set-payload><![CDATA[%dw 2.0
output application/json
---
{
  error: {
    code: "NOT_FOUND",
    message: "Party not found",
    timestamp: now()
  }
}]]></ee:set-payload>
            </ee:message>
          </ee:transform>
          <set-variable value="404" doc:name="httpStatus" doc:id="d3d4a356-1b30-4ea3-bf48-82e66c597694" variableName="httpStatus"/>
        </otherwise>
      </choice>
      
      <error-handler>
        <on-error-propagate type="*" enableNotifications="true" logException="true" doc:name="Error Handler">
          <ee:transform doc:name="Transform Error">
            <ee:message>
              <ee:set-payload><![CDATA[%dw 2.0
output application/json
---
{
  error: {
    code: "DATABASE_ERROR",
    message: "An error occurred while querying the database",
    timestamp: now()
  }
}]]></ee:set-payload>
            </ee:message>
          </ee:transform>
          <set-variable value="500" doc:name="httpStatus" doc:id="d3d4a356-1b30-4ea3-bf48-82e66c597694" variableName="httpStatus"/>
        </on-error-propagate>
      </error-handler>
    </try>
  </flow>

  <!-- POST /parties/lookup - Business Logic Flow -->
  <flow name="lookup-party-business-logic" doc:name="lookup-party-business-logic">
    <try doc:name="Try">
      <db:select config-ref="Database_Config" doc:name="Lookup Party by External ID">
        <db:sql><![CDATA[
          SELECT gp.*
          FROM global_parties gp
          INNER JOIN external_ids ei ON gp.global_id = ei.global_id
          WHERE ei.external_system = :externalSystem
            AND ei.external_value = :externalValue
            AND ei.entity_type = 'party'
        ]]></db:sql>
        <db:input-parameters><![CDATA[#[%dw 2.0
output application/java
var externalId = payload.externalId default {}
---
{
  externalSystem: externalId.system,
  externalValue: externalId.value
}]]]></db:input-parameters>
      </db:select>

      <choice doc:name="Party Found?">
        <when expression="#[sizeOf(payload) > 0]">
          <ee:transform doc:name="Store Party">
            <ee:variables>
              <ee:set-variable variableName="party"><![CDATA[%dw 2.0
output application/java
--- payload[0]]]></ee:set-variable>
            </ee:variables>
          </ee:transform>

          <db:select config-ref="Database_Config" doc:name="Get External IDs">
            <db:sql><![CDATA[
              SELECT external_system, external_value
              FROM external_ids
              WHERE global_id = :partyGlobalId::uuid
                AND entity_type = 'party'
            ]]></db:sql>
            <db:input-parameters><![CDATA[#[%dw 2.0
output application/java
---
{
  partyGlobalId: vars.party.global_id
}]]]></db:input-parameters>
          </db:select>

          <ee:transform doc:name="Transform Response">
            <ee:message>
              <ee:set-payload><![CDATA[%dw 2.0
output application/json
var party = vars.party
var externalIds = payload
---
{
  id: party.id as String,
  globalId: party.global_id as String,
  partyType: party.party_type,
  firstName: party.first_name,
  lastName: party.last_name,
  middleName: party.middle_name,
  organizationName: party.organization_name,
  dateOfBirth: party.date_of_birth,
  taxId: party.tax_id,
  externalIds: externalIds map ((ext) -> {
    system: ext.external_system,
    value: ext.external_value
  }),
  createdAt: party.created_at,
  updatedAt: party.updated_at
}]]></ee:set-payload>
            </ee:message>
          </ee:transform>
          <set-variable value="200" doc:name="httpStatus" doc:id="d3d4a356-1b30-4ea3-bf48-82e66c597694" variableName="httpStatus"/>
        </when>
        <otherwise>
          <ee:transform doc:name="Error Response">
            <ee:message>
              <ee:set-payload><![CDATA[%dw 2.0
output application/json
---
{
  error: {
    code: "NOT_FOUND",
    message: "Party not found for the given external ID",
    timestamp: now()
  }
}]]></ee:set-payload>
            </ee:message>
          </ee:transform>
          <set-variable value="404" doc:name="httpStatus" doc:id="d3d4a356-1b30-4ea3-bf48-82e66c597694" variableName="httpStatus"/>
        </otherwise>
      </choice>
      
      <error-handler>
        <on-error-propagate type="*" enableNotifications="true" logException="true" doc:name="Error Handler">
          <ee:transform doc:name="Transform Error">
            <ee:message>
              <ee:set-payload><![CDATA[%dw 2.0
output application/json
---
{
  error: {
    code: "DATABASE_ERROR",
    message: "An error occurred while looking up the party",
    timestamp: now()
  }
}]]></ee:set-payload>
            </ee:message>
          </ee:transform>
          <set-variable value="500" doc:name="httpStatus" doc:id="d3d4a356-1b30-4ea3-bf48-82e66c597694" variableName="httpStatus"/>
        </on-error-propagate>
      </error-handler>
    </try>
  </flow>

</mule>
